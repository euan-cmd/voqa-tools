<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workplace EV Charging RoI Calculator - Voqa</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #005C80;
            --primary-dark: #004A6B;
            --accent: #F7D7BC;
            --accent-light: #F8D4B4;
            --success: #098C47;
            --danger: #FF4747;
            --text-dark: #0E215A;
            --text-light: #ffffff;
            --bg-light: #f8f9fa;
            --border: #E8F0F0;
        }
        
        body {
            font-family: 'Red Hat Display', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            min-height: 100vh;
            color: var(--text-light);
            line-height: 1.6;
            padding-top: 140px;
        }

        /* Fixed Header */
        .header-fixed {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            background: rgba(0, 92, 128, 0.98);
            backdrop-filter: blur(20px);
            padding: 24px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 9999;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 40px;
            text-align: center;
        }

        .header-title {
            font-size: clamp(24px, 5vw, 36px);
            font-weight: 800;
            color: var(--text-light);
            margin-bottom: 20px;
        }

        .header-cta {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(45deg, var(--accent), var(--accent-light));
            color: var(--primary);
            padding: 16px 24px;
            border-radius: 50px;
            font-weight: 700;
            text-decoration: none;
            transition: transform 0.3s ease;
        }

        .header-cta:hover {
            transform: translateY(-2px);
        }

        .back-to-calculators {
            position: absolute;
            top: 20px;
            left: 40px;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .back-to-calculators:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        /* Main Content */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 40px;
        }

        .card {
            background: rgba(255, 255, 255, 0.98);
            color: var(--text-dark);
            padding: 32px;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0, 92, 128, 0.12);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .section-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            background: white;
            color: var(--text-dark);
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 92, 128, 0.1);
        }

        .calculation-display {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 24px;
            border-radius: 16px;
            margin-top: 12px;
            color: var(--text-light);
        }

        .calc-header {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .calc-explainer {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.5;
            font-style: italic;
        }

        .warning-message {
            margin-top: 10px;
            padding: 12px 16px;
            background: #FFF3CD;
            border: 2px solid #FFD93D;
            border-radius: 10px;
            color: #856404;
            font-size: 14px;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .warning-message.show {
            display: flex;
        }

        .custom-note {
            margin-top: 8px;
            font-size: 12px;
            font-style: italic;
            color: #666;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        .table-container {
            overflow-x: auto;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        th {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            font-weight: 600;
        }

        .total-row {
            background: var(--accent);
            font-weight: 700;
            color: var(--text-dark);
        }

        .total-row td {
            border-bottom: none;
            font-size: 16px;
        }

        /* Summary and Results */
        .summary-box {
            background: var(--bg-light);
            padding: 30px;
            border-radius: 16px;
            margin-top: 20px;
        }

        .summary-title {
            font-size: 22px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 25px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 16px;
            padding: 12px 0;
        }

        .summary-item.main {
            font-weight: 800;
            font-size: 18px;
            color: var(--primary);
            border-top: 2px solid var(--accent);
            padding-top: 20px;
            margin-top: 20px;
        }

        .positive {
            color: var(--success);
            font-weight: 700;
        }

        .negative {
            color: var(--danger);
            font-weight: 700;
        }

        .section-subtitle {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            margin: 30px 0 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-subtitle::before {
            content: '';
            width: 30px;
            height: 3px;
            background: var(--accent);
            border-radius: 2px;
        }

        /* Charts */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .result-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 24px;
            border-radius: 16px;
            color: var(--text-light);
            text-align: center;
        }

        .result-icon {
            font-size: 48px;
            margin-bottom: 16px;
            display: block;
        }

        .result-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .result-label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .result-description {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.4;
        }

        .chart-container {
            margin-bottom: 40px;
        }

        .chart-wrapper {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 30px rgba(0, 92, 128, 0.1);
            position: relative;
        }

        .chart-wrapper::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
        }

        .cash-flow-container {
            grid-column: 1 / -1;
            margin-top: 40px;
        }

        /* Guidance and Benefits */
        .guidance-section {
            margin-top: 30px;
            padding: 25px;
            background: var(--bg-light);
            border-radius: 16px;
        }

        .guidance-title {
            color: var(--primary);
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 15px;
        }

        .guidance-text {
            font-size: 14px;
            color: var(--text-dark);
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .benefits-list {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }

        .benefits-list li {
            margin-bottom: 12px;
            padding-left: 30px;
            position: relative;
            color: var(--text-dark);
            font-size: 14px;
            line-height: 1.8;
        }

        .benefits-list li::before {
            content: '✓';
            position: absolute;
            left: 0;
            color: var(--success);
            font-weight: bold;
            font-size: 18px;
        }

        .cta-container {
            margin-top: 30px;
            text-align: center;
            background: rgba(255, 255, 255, 0.98);
            color: var(--text-dark);
            padding: 30px;
            border-radius: 16px;
        }

        .cta-button {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(45deg, var(--accent), var(--accent-light));
            color: var(--primary);
            padding: 18px 32px;
            border-radius: 50px;
            font-weight: 700;
            text-decoration: none;
            transition: transform 0.3s ease;
        }

        .cta-button:hover {
            transform: translateY(-3px);
        }

        /* Responsive Design */
        @media (min-width: 1200px) {
            .container {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 900px) {
            body {
                padding-top: 160px;
            }
            
            .back-to-calculators {
                left: 20px;
                top: 16px;
                padding: 8px 14px;
                font-size: 13px;
            }

            .container {
                padding: 30px 20px;
            }

            .header-content {
                padding: 0 20px;
            }

            .card {
                padding: 24px;
            }

            th, td {
                padding: 8px;
                font-size: 12px;
            }
        }

        @media (max-width: 600px) {
            body {
                padding-top: 180px;
            }

            .header {
                padding: 16px 0;
            }

            .header-content {
                padding: 0 15px;
            }

            .header-title {
                font-size: 20px;
            }

            .header-cta {
                padding: 12px 20px;
                font-size: 14px;
            }

            .container {
                padding: 20px 15px;
                gap: 20px;
            }

            .card {
                padding: 20px;
            }

            .section-title {
                font-size: 20px;
            }

            .chart-wrapper {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Fixed Header -->
    <div class="header-fixed">
        <a href="https://euan-cmd.github.io/voqa-tools/" class="back-to-calculators">
            ← Back to Calculators
        </a>
        <div class="header-content">
            <div class="header-title">⚡ Workplace EV Charging RoI Calculator</div>
            <a href="https://calendar.app.google/C919wsfwk71WB3Qo6" target="_blank" class="header-cta">
                📅 Book some time with Voqa to talk about EV Charging
            </a>
        </div>
    </div>

    <div class="container">
        <!-- Configuration Card -->
        <div class="card">
            <h2 class="section-title">⚙️ Configure Your Setup</h2>
            
            <div class="guidance-section">
                <h4 class="guidance-title">How to Use This Calculator</h4>
                <div class="guidance-text">
                    This RoI calculator helps you understand the financial returns from installing EV charging infrastructure at your workplace. 
                    Input your specific parameters to get detailed payback periods, ROI projections, and cash flow analysis.
                </div>
                <div class="guidance-text">
                    The calculator accounts for UK workplace charging grants, typical installation costs, and revenue from charging sessions to provide realistic financial projections.
                </div>
            </div>
            
            <div class="form-group">
                <label for="totalBays">Number of Car Parking Bays at your location</label>
                <input type="number" id="totalBays" value="100" min="1">
                <div class="custom-note">Total parking spaces available at your workplace</div>
            </div>

            <div class="form-group">
                <label for="peakOccupancy">Peak Occupancy on your busiest day (%)</label>
                <select id="peakOccupancy">
                    <option value="25">25%</option>
                    <option value="50">50%</option>
                    <option value="75" selected>75%</option>
                    <option value="100">100%</option>
                </select>
                <div class="custom-note">Percentage of parking spaces typically occupied during peak times</div>
            </div>

            <div class="form-group">
                <div class="calculation-display">
                    <div class="calc-header">🔌 Estimated Number of Bays Required</div>
                    <div style="margin-top: 15px;">
                        <div class="calc-header" style="font-size: 16px; margin-bottom: 5px;">
                            2025 (5% EV penetration): <span id="evBaysRequired2025">-</span>
                        </div>
                        <div class="calc-explainer" style="margin-bottom: 15px;">
                            <span id="evBaysExplainer2025">-</span>
                        </div>
                        <div class="calc-header" style="font-size: 16px; margin-bottom: 5px;">
                            2030 (20% EV penetration): <span id="evBaysRequired2030">-</span>
                        </div>
                        <div class="calc-explainer" style="margin-bottom: 15px;">
                            <span id="evBaysExplainer2030">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="evBaysOverride">How many bays to enable with an EV charging port</label>
                <input type="number" id="evBaysOverride" placeholder="Leave blank to use 2025 calculation (5% penetration)" min="0" step="2">
                <div id="evBaysWarning" class="warning-message">
                    ⚠️ Warning: Number of EV bays must be a multiple of 2 (for dual-socket units)
                </div>
                <div class="custom-note">Override the calculated number with your preferred amount (must be even for dual-port units)</div>
            </div>

            <div class="form-group">
                <label for="installationCost">Installation Cost per Bay (£)</label>
                <input type="number" id="installationCost" value="2000" min="0" step="0.01">
                <div class="custom-note">Costs of site preparation and installation can vary widely however for a typical installation £2,000 is not untypical</div>
            </div>

            <div class="form-group">
                <label for="unitCostInput">Cost of Dual Port Unit (£)</label>
                <input type="number" id="unitCostInput" value="2800" min="0" step="0.01">
                <div class="custom-note">Hardware cost for each dual-port charging unit</div>
            </div>

            <div class="form-group">
                <label for="pricePerKwh">Price per kWh excluding VAT (£)</label>
                <input type="number" id="pricePerKwh" value="0.50" min="0" step="0.01">
                <div class="custom-note">What you charge users per kWh of electricity consumed</div>
            </div>

            <div class="form-group">
                <label for="electricityCost">Cost of Electricity per kWh excluding VAT (£)</label>
                <input type="number" id="electricityCost" value="0.25" min="0" step="0.01">
                <div class="custom-note">Your actual cost of electricity from your energy supplier</div>
            </div>

            <div class="form-group">
                <div class="calculation-display">
                    <div class="calc-header">💰 Commission per kWh: £0.06</div>
                    <div class="calc-explainer">Commission fee levied on billed kWh transactions</div>
                </div>
            </div>

            <div class="form-group">
                <label for="chargingRate">Charger Configuration</label>
                <select id="chargingRate">
                    <option value="7.4" selected>7.4kW Dual Port</option>
                    <option value="22">22kW Dual Port</option>
                </select>
                <div class="custom-note">Dual-port units share power between two cars when both ports are in use. Each car receives 50% of the total power.</div>
            </div>

            <div class="form-group">
                <label for="sessionsPerPort">Sessions per Port per Day</label>
                <input type="number" id="sessionsPerPort" value="2" min="0" step="0.1">
                <div class="custom-note">Average number of different vehicles using each charging port daily</div>
            </div>

            <div class="form-group">
                <label for="sessionDuration">Duration of Active Charging per Session (hours)</label>
                <input type="number" id="sessionDuration" value="3" min="0" step="0.1">
                <div class="calc-explainer" style="margin-top: 8px; font-size: 12px; font-style: italic; color: #666;">
                    <span id="rangeExplanation">*EVs charging for 3 hours under the selected configuration will typically add range to their battery.</span>
                </div>
            </div>

            <div class="form-group">
                <label for="daysPerWeek">Days per Week Charging Available</label>
                <select id="daysPerWeek">
                    <option value="1">1 day</option>
                    <option value="2">2 days</option>
                    <option value="3">3 days</option>
                    <option value="4">4 days</option>
                    <option value="5" selected>5 days</option>
                    <option value="6">6 days</option>
                    <option value="7">7 days</option>
                </select>
                <div class="custom-note">How many days per week your charging infrastructure operates</div>
            </div>
        </div>

        <!-- Results Card -->
        <div class="card">
            <h2 class="section-title">📊 RoI Analysis Summary</h2>
            
            <h3 class="section-subtitle">INVESTMENTS</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Calculation</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>EV Charging Units</td>
                            <td id="unitCalc">-</td>
                            <td id="unitCost">-</td>
                        </tr>
                        <tr>
                            <td>Installation Costs</td>
                            <td id="installCalc">-</td>
                            <td id="installCostTotal">-</td>
                        </tr>
                        <tr>
                            <td>Workplace Charging Grant</td>
                            <td id="grantCalc">-</td>
                            <td id="grantSaving" style="color: #098C47;">-</td>
                        </tr>
                        <tr class="total-row">
                            <td><strong>Total Initial Investment</strong></td>
                            <td></td>
                            <td id="totalInvestment"><strong>-</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3 class="section-subtitle">PROFITS</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Calculation</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Daily kWh Consumption</td>
                            <td id="kwhCalc">-</td>
                            <td id="dailyKwh">-</td>
                        </tr>
                        <tr>
                            <td>Net Profit per kWh</td>
                            <td id="profitCalc">-</td>
                            <td id="netProfit">-</td>
                        </tr>
                        <tr>
                            <td>Daily Profit</td>
                            <td id="dailyRevCalc">-</td>
                            <td id="dailyRevenue">-</td>
                        </tr>
                        <tr>
                            <td>Weekly Profit</td>
                            <td id="weeklyRevCalc">-</td>
                            <td id="weeklyRevenue">-</td>
                        </tr>
                        <tr class="total-row">
                            <td><strong>Year 1 Profit from EV charging</strong></td>
                            <td id="annualRevCalc">-</td>
                            <td id="annualRevenue"><strong>-</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 15px; margin-bottom: 25px; padding: 15px; background: var(--bg-light); border-radius: 8px;">
                <p style="color: var(--text-dark); font-size: 14px; line-height: 1.6; margin: 0;">
                    <strong>Note:</strong> RoI and Payback calculations assume a 5% year-on-year increase in utilisation to account for growing EV adoption and increased charging frequency.
                </p>
            </div>

            <div class="summary-box">
                <h3 class="summary-title">💼 RoI SUMMARY</h3>
                <div class="summary-item main">
                    <span>Payback Period:</span>
                    <span id="paybackPeriod">-</span>
                </div>
                <div class="summary-item main">
                    <span>5-Year RoI:</span>
                    <span id="fiveYearROI">-</span>
                </div>
            </div>
            
            <div class="cta-container">
                <a href="https://calendar.app.google/C919wsfwk71WB3Qo6" target="_blank" class="cta-button">
                    📅 Book some time with Voqa to talk about EV Charging
                </a>
                
                <div class="guidance-section">
                    <h4 class="guidance-title" style="margin-bottom: 10px;">Beyond Financial Returns</h4>
                    <p style="color: var(--text-dark); font-size: 14px; line-height: 1.6; margin-bottom: 15px;">
                        Returns made from EV charging directly don't form all of the benefit that you will accrue as a business. Consider the impact that availability of EV charging will have on:
                    </p>
                    <ul class="benefits-list">
                        <li><strong>Recruitment & Retention:</strong> EV charging is increasingly viewed as an essential workplace amenity</li>
                        <li><strong>Carbon Reduction Plan:</strong> Demonstrates tangible commitment to sustainability goals</li>
                        <li><strong>Reputational Benefits:</strong> Positions your business as environmentally responsible</li>
                        <li><strong>Employee Satisfaction:</strong> Reduces range anxiety and provides convenience for EV-driving staff</li>
                        <li><strong>Future-Proofing:</strong> Prepares your infrastructure for the inevitable increase in EV adoption</li>
                        <li><strong>Compliance Readiness:</strong> Positions you ahead of potential future regulations</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Cash Flow Analysis -->
        <div id="cashFlowContainer" class="cash-flow-container">
            <div class="card">
                <h2 class="section-title" style="margin-bottom: 30px;">📈 Detailed Cash Flow Analysis</h2>
                
                <div class="chart-container">
                    <h3 class="section-subtitle">Annual Cash Flow Analysis</h3>
                    <div class="mobile-landscape-notice">
                        For the best chart viewing experience on mobile, rotate your device to landscape mode
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="cashFlowChart" width="800" height="400"></canvas>
                    </div>
                    <div class="guidance-section">
                        <div class="guidance-text">
                            <strong>Annual Cash Flow Analysis:</strong> This chart shows your yearly cash flow. The red bar represents the initial investment, 
                            while the green bars show annual profits from EV charging operations. Break-even typically occurs around <span id="breakEvenCommentary">-</span>.
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3 class="section-subtitle">Cumulative Cash Flow Analysis</h3>
                    <div class="mobile-landscape-notice">
                        For the best chart viewing experience on mobile, rotate your device to landscape mode
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="cumulativeChart" width="800" height="400"></canvas>
                    </div>
                    <div class="guidance-section">
                        <div class="guidance-text">
                            <strong>Cumulative Analysis:</strong> This chart tracks your total accumulated cash position year by year. 
                            The break-even point shows when your total cash position returns to zero, indicating full recovery of your initial investment.
                        </div>
                    </div>
                </div>
                
                <div class="results-grid">
                    <div class="result-card">
                        <span class="result-icon">💰</span>
                        <div class="result-value" id="investmentInsight">-</div>
                        <div class="result-label">Initial Investment</div>
                        <div class="result-description">Total upfront cost for EV charging infrastructure</div>
                    </div>
                    <div class="result-card">
                        <span class="result-icon">⏱️</span>
                        <div class="result-value" id="breakEvenInsight">-</div>
                        <div class="result-label">Break-even Time</div>
                        <div class="result-description">Time to recover initial investment</div>
                    </div>
                    <div class="result-card">
                        <span class="result-icon">📈</span>
                        <div class="result-value" id="fiveYearProfitInsight">-</div>
                        <div class="result-label">5-Year Profit</div>
                        <div class="result-description">Total profit after 5 years of operation</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // Global variables
        let cashFlowChart = null;
        let cumulativeChart = null;
        let currentCalculationData = {};

        // Utility functions
        function roundUpToNearestEven(num) {
            if (num <= 0) return 0;
            return Math.ceil(num / 2) * 2;
        }

        function formatCurrency(amount) {
            if (amount < 0) {
                return '(£' + Math.abs(amount).toLocaleString('en-GB', {minimumFractionDigits: 0, maximumFractionDigits: 0}) + ')';
            }
            return '£' + amount.toLocaleString('en-GB', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        }

        function formatCurrencyDetailed(amount) {
            if (amount < 0) {
                return '(£' + Math.abs(amount).toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ')';
            }
            return '£' + amount.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        function formatNumber(num, decimals = 1) {
            return num.toLocaleString('en-GB', {minimumFractionDigits: decimals, maximumFractionDigits: decimals});
        }

        // Main calculation function
        function calculate() {
            try {
                const totalBays = parseInt(document.getElementById('totalBays').value) || 0;
                const peakOccupancy = parseInt(document.getElementById('peakOccupancy').value) || 0;
                const installationCost = parseFloat(document.getElementById('installationCost').value) || 0;
                const unitCostInput = parseFloat(document.getElementById('unitCostInput').value) || 0;
                const pricePerKwh = parseFloat(document.getElementById('pricePerKwh').value) || 0;
                const electricityCost = parseFloat(document.getElementById('electricityCost').value) || 0;
                const sessionsPerPort = parseFloat(document.getElementById('sessionsPerPort').value) || 0;
                const sessionDuration = parseFloat(document.getElementById('sessionDuration').value) || 0;
                const chargingRate = parseFloat(document.getElementById('chargingRate').value) || 7.4;
                const daysPerWeek = parseInt(document.getElementById('daysPerWeek').value) || 0;
                const evBaysOverride = parseInt(document.getElementById('evBaysOverride').value) || 0;

                // Calculate EV bays required
                const calculatedEVBays2025 = roundUpToNearestEven((totalBays * peakOccupancy / 100) * 0.05);
                const calculatedEVBays2030 = roundUpToNearestEven((totalBays * peakOccupancy / 100) * 0.20);
                
                let requiredEVBays = calculatedEVBays2025;
                
                if (evBaysOverride > 0) {
                    requiredEVBays = evBaysOverride;
                    
                    const warningElement = document.getElementById('evBaysWarning');
                    if (evBaysOverride % 2 !== 0) {
                        warningElement.classList.add('show');
                    } else {
                        warningElement.classList.remove('show');
                    }
                } else {
                    document.getElementById('evBaysWarning').classList.remove('show');
                }
                
                const numberOfUnits = requiredEVBays / 2;
                const occupiedBays = totalBays * peakOccupancy / 100;
                const rawEVBays2025 = occupiedBays * 0.05;
                const rawEVBays2030 = occupiedBays * 0.20;
                
                // Update bay requirements display
                document.getElementById('evBaysRequired2025').textContent = calculatedEVBays2025 + ' bays';
                document.getElementById('evBaysExplainer2025').textContent = 
                    `${totalBays} total bays × ${peakOccupancy}% occupancy × 5% EV adoption = ${formatNumber(rawEVBays2025, 2)} bays, rounded up to nearest even number (${calculatedEVBays2025}) for dual-socket units`;
                    
                document.getElementById('evBaysRequired2030').textContent = calculatedEVBays2030 + ' bays';
                document.getElementById('evBaysExplainer2030').textContent = 
                    `${totalBays} total bays × ${peakOccupancy}% occupancy × 20% EV adoption = ${formatNumber(rawEVBays2030, 2)} bays, rounded up to nearest even number (${calculatedEVBays2030}) for dual-socket units`;

                // Calculate range explanation
                const effectiveChargingRate = chargingRate / 2;
                const kwhAdded = sessionDuration * effectiveChargingRate;
                const milesAdded = kwhAdded * 3.5;
                document.getElementById('rangeExplanation').textContent = 
                    `*EVs charging for ${sessionDuration} hours under the selected configuration will typically add ${formatNumber(milesAdded, 1)} miles of range to their battery.`;

                // Calculate costs and revenues
                const unitCost = numberOfUnits * unitCostInput;
                const installCostTotal = requiredEVBays * installationCost;
                const grantEligibleBays = Math.min(requiredEVBays, 40);
                const grantSaving = grantEligibleBays * 350;
                const totalInvestment = unitCost + installCostTotal - grantSaving;

                const dailyKwh = requiredEVBays * sessionsPerPort * sessionDuration * effectiveChargingRate;
                const netProfit = pricePerKwh - electricityCost - 0.06;
                const dailyRevenue = dailyKwh * netProfit;
                const weeklyRevenue = dailyRevenue * daysPerWeek;
                const annualRevenue = weeklyRevenue * 52;

                // Calculate 5-year revenue with growth
                let totalCumulativeRevenue = 0;
                for (let year = 1; year <= 5; year++) {
                    const growthMultiplier = Math.pow(1.05, year - 1);
                    const yearlyRevenue = annualRevenue * growthMultiplier;
                    totalCumulativeRevenue += yearlyRevenue;
                }
                
                // Calculate payback period
                let cumulativeRevenue = 0;
                let paybackYears = 0;
                for (let year = 1; year <= 20; year++) {
                    const growthMultiplier = Math.pow(1.05, year - 1);
                    const yearlyRevenue = annualRevenue * growthMultiplier;
                    cumulativeRevenue += yearlyRevenue;
                    
                    if (cumulativeRevenue >= totalInvestment) {
                        const previousCumulative = cumulativeRevenue - yearlyRevenue;
                        const remainingInvestment = totalInvestment - previousCumulative;
                        const fractionOfYear = remainingInvestment / yearlyRevenue;
                        paybackYears = (year - 1) + fractionOfYear;
                        break;
                    }
                }
                
                const paybackMonths = paybackYears * 12;
                const fiveYearROI = ((totalCumulativeRevenue - totalInvestment) / totalInvestment) * 100;

                // Update display elements
                document.getElementById('unitCalc').textContent = `${numberOfUnits} units × ${formatCurrencyDetailed(unitCostInput)}`;
                document.getElementById('unitCost').textContent = formatCurrencyDetailed(unitCost);
                document.getElementById('installCalc').textContent = `${requiredEVBays} bays × ${formatCurrencyDetailed(installationCost)}`;
                document.getElementById('installCostTotal').textContent = formatCurrencyDetailed(installCostTotal);
                document.getElementById('grantCalc').textContent = `${grantEligibleBays} bays × £350 (up to 40 bays)`;
                document.getElementById('grantSaving').textContent = formatCurrencyDetailed(-grantSaving);
                document.getElementById('totalInvestment').textContent = formatCurrencyDetailed(totalInvestment);

                document.getElementById('kwhCalc').textContent = `${requiredEVBays} ports × ${sessionsPerPort} sessions × ${sessionDuration}hrs × ${effectiveChargingRate}kW`;
                document.getElementById('dailyKwh').textContent = formatNumber(dailyKwh) + ' kWh';
                document.getElementById('profitCalc').textContent = `${formatCurrencyDetailed(pricePerKwh)} - ${formatCurrencyDetailed(electricityCost)} - £0.06`;
                document.getElementById('netProfit').textContent = formatCurrencyDetailed(netProfit);
                document.getElementById('dailyRevCalc').textContent = `${formatNumber(dailyKwh)} kWh × ${formatCurrencyDetailed(netProfit)}`;
                document.getElementById('dailyRevenue').textContent = formatCurrencyDetailed(dailyRevenue);
                document.getElementById('weeklyRevCalc').textContent = `${formatCurrencyDetailed(dailyRevenue)} × ${daysPerWeek} days`;
                document.getElementById('weeklyRevenue').textContent = formatCurrencyDetailed(weeklyRevenue);
                document.getElementById('annualRevCalc').textContent = `${formatCurrencyDetailed(weeklyRevenue)} × 52 weeks`;
                document.getElementById('annualRevenue').textContent = formatCurrencyDetailed(annualRevenue);

                // Format payback period
                let paybackText;
                if (paybackYears < 1) {
                    paybackText = `${Math.ceil(paybackMonths)} months`;
                } else {
                    const wholeYears = Math.floor(paybackYears);
                    const remainingMonths = Math.round((paybackYears - wholeYears) * 12);
                    if (remainingMonths === 0) {
                        paybackText = `${wholeYears} years`;
                    } else {
                        paybackText = `${wholeYears} years ${remainingMonths} months`;
                    }
                }
                
                document.getElementById('paybackPeriod').textContent = paybackText;
                document.getElementById('fiveYearROI').textContent = formatNumber(fiveYearROI) + '%';

                const roiElement = document.getElementById('fiveYearROI');
                roiElement.className = fiveYearROI > 0 ? 'positive' : 'negative';

                // Store calculation data for charts
                currentCalculationData = {
                    totalInvestment,
                    monthlyRevenue: weeklyRevenue * 52 / 12,
                    annualRevenue,
                    paybackMonths,
                    fiveYearRevenue: totalCumulativeRevenue,
                    fiveYearROI
                };

                generateCharts();

            } catch (error) {
                console.error('Calculation error:', error);
            }
        }

        // Chart generation function
        function generateCharts() {
            if (!currentCalculationData || !currentCalculationData.totalInvestment) {
                return;
            }
            
            const { totalInvestment, monthlyRevenue, paybackMonths, fiveYearRevenue } = currentCalculationData;
            
            const yearsToShow = Math.max(5, Math.ceil(paybackMonths / 12) + 2);
            const years = [];
            const annualCashFlow = [];
            const cumulative = [];
            
            let cumulativeTotal = -totalInvestment;
            
            for (let year = 0; year <= yearsToShow; year++) {
                if (year === 0) {
                    years.push('Initial');
                    annualCashFlow.push(-totalInvestment);
                    cumulative.push(cumulativeTotal);
                } else {
                    years.push(`Year ${year}`);
                    const growthMultiplier = Math.pow(1.05, year - 1);
                    const annualProfit = (monthlyRevenue * 12) * growthMultiplier;
                    annualCashFlow.push(annualProfit);
                    cumulativeTotal += annualProfit;
                    cumulative.push(cumulativeTotal);
                }
            }

            // Update insights
            const breakEvenYears = paybackMonths / 12;
            let breakEvenText;
            if (breakEvenYears < 1) {
                breakEvenText = `${Math.ceil(paybackMonths)} months`;
            } else {
                const wholeYears = Math.floor(breakEvenYears);
                const remainingMonths = Math.ceil(paybackMonths - (wholeYears * 12));
                breakEvenText = remainingMonths > 0 ? `${wholeYears} years ${remainingMonths} months` : `${wholeYears} years`;
            }
            
            document.getElementById('breakEvenCommentary').textContent = breakEvenText;
            document.getElementById('investmentInsight').textContent = formatCurrency(totalInvestment);
            document.getElementById('breakEvenInsight').textContent = breakEvenText;
            document.getElementById('fiveYearProfitInsight').textContent = formatCurrency(fiveYearRevenue - totalInvestment);

            // Destroy existing charts
            if (cashFlowChart) {
                cashFlowChart.destroy();
                cashFlowChart = null;
            }
            if (cumulativeChart) {
                cumulativeChart.destroy();
                cumulativeChart = null;
            }

            // Create annual cash flow chart
            const cashFlowCtx = document.getElementById('cashFlowChart');
            if (cashFlowCtx) {
                cashFlowChart = new Chart(cashFlowCtx, {
                    type: 'bar',
                    data: {
                        labels: years,
                        datasets: [{
                            label: 'Annual Cash Flow',
                            data: annualCashFlow,
                            backgroundColor: annualCashFlow.map(value => value < 0 ? '#FF4747' : '#098C47'),
                            borderColor: annualCashFlow.map(value => value < 0 ? '#FF4747' : '#098C47'),
                            borderWidth: 2,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Cash Flow: ' + formatCurrency(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Annual Cash Flow (£)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Year'
                                }
                            }
                        }
                    }
                });
            }

            // Create cumulative cash flow chart
            const cumulativeCtx = document.getElementById('cumulativeChart');
            if (cumulativeCtx) {
                cumulativeChart = new Chart(cumulativeCtx, {
                    type: 'line',
                    data: {
                        labels: years,
                        datasets: [{
                            label: 'Cumulative Cash Flow',
                            data: cumulative,
                            borderColor: '#005C80',
                            backgroundColor: 'rgba(0, 92, 128, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.3,
                            pointBackgroundColor: cumulative.map(value => value < 0 ? '#FF4747' : '#098C47'),
                            pointBorderColor: cumulative.map(value => value < 0 ? '#FF4747' : '#098C47'),
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Cumulative: ' + formatCurrency(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                grid: {
                                    color: function(context) {
                                        return context.tick.value === 0 ? '#FF4747' : 'rgba(0, 92, 128, 0.1)';
                                    }
                                },
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Cumulative Cash Position (£)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Year'
                                }
                            }
                        }
                    }
                });
            }
        }

        // Initialize the application
        function initializeApp() {
            try {
                // Add event listeners
                document.getElementById('totalBays').addEventListener('input', calculate);
                document.getElementById('peakOccupancy').addEventListener('change', calculate);
                document.getElementById('installationCost').addEventListener('input', calculate);
                document.getElementById('unitCostInput').addEventListener('input', calculate);
                document.getElementById('pricePerKwh').addEventListener('input', calculate);
                document.getElementById('electricityCost').addEventListener('input', calculate);
                document.getElementById('sessionsPerPort').addEventListener('input', calculate);
                document.getElementById('sessionDuration').addEventListener('input', calculate);
                document.getElementById('evBaysOverride').addEventListener('input', calculate);
                document.getElementById('daysPerWeek').addEventListener('change', calculate);
                document.getElementById('chargingRate').addEventListener('change', calculate);

                // Initial calculation
                calculate();

            } catch (error) {
                console.error('Initialization error:', error);
            }
        }

        // Start the app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>

